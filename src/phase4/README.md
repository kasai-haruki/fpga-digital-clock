# Phase 4: 統合プロジェクト

## 概要

Phase 4では、Phase 2とPhase 3の成果を統合し、5つの機能（時刻表示、時刻設定、アラーム、ストップウォッチ、タイマー）を実装しました。

**開発期間**: 1週間  
**目的**: 全機能の統合、設定機能の実装、実機テスト  
**実装済み**: 時刻表示モード、時刻設定モード（2機能）  
**実装予定**: アラーム、ストップウォッチ、タイマー（3機能）

---

## 実装モジュール

### トップレベル
| ファイル名 | 説明 |
|-----------|------|
| P4_CLOCK_ALL.v | トップモジュール、全モジュールを統合 |

### 状態管理
| ファイル名 | 説明 |
|-----------|------|
| P4_MAIN_MODE.v | 動作モード管理（5状態）、ワンホット方式 |
| P4_SET_MODE.v | 設定モード処理（7状態）、各桁の個別設定 |
| P4_DIS_MODE.v | 表示切替処理（7状態）、7種類の表示 |
| P4_MSE.v | 統合入力処理（メタステビリティ+チャタリング+エッジ検出） |

### カウンタ（設定機能追加版）
| ファイル名 | 説明 |
|-----------|------|
| P4_CNT60.v | 60進カウンタ、通常動作+設定機能 |
| P4_CNT24.v | 24時間カウンタ、通常動作+設定機能 |
| P4_CNT_DAY.v | 日カウンタ、通常動作+設定機能 |
| P4_CNT_MONTH.v | 月カウンタ、通常動作+設定機能 |
| P4_CNT_YEAR.v | 年カウンタ、通常動作+設定機能 |

### 表示・その他
| ファイル名 | 説明 |
|-----------|------|
| P4_DECODER7.v | デコーダ、数字+曜日表示対応 |
| P4_DCOUNT.v | ダイナミック点灯制御 |
| P4_display_switch.v | 表示データ切替、モードに応じた表示 |
| P4_leap_year.v | うるう年判定 |
| P4_weekday_calc.v | 曜日計算（ブロックRAM使用） |
| P4_SEC1.v | クロック生成 |

---

## 主な機能

### 1. 時刻表示モード

**機能**:
- 年月日・曜日・時分秒のリアルタイム表示
- うるう年自動判定
- 101年間のループ動作（2000-2100年）

**表示パターン（7種類）**:
```
L1: 年     → "2024"
L2: 年月   → "24 12"（2024年12月）
L3: 月曜日 → "12 MO"（12月月曜）
L4: 曜日日 → "MO 19"（月曜19日）
L5: 日時   → "19 20"（19日20時）
L6: 時分   → "20 00"（20時00分）
L7: 分秒   → "00 00"（00分00秒）
```

**オリジナル曜日パターン**:
```
日曜: SU    月曜: MO    火曜: TU    水曜: WE
木曜: TH    金曜: FR    土曜: SA
```

### 2. 時刻設定モード

**機能**:
- 年・月・日・時・分・秒を個別に設定
- 設定中の桁を点滅表示（視認性向上）
- ボタンでインクリメント操作
- 設定完了後、即座に通常動作に復帰

**状態遷移**:
```
L1: 通常動作 → L2: 年設定 → L3: 月設定 → L4: 日設定 → 
L5: 時設定 → L6: 分設定 → L7: 秒設定 → L1: 完了
```

**ワンホットエンコーディングの活用**:
```verilog
// SET_MODE: 7状態を7ビットで表現
parameter L1 = 7'b0000001,  // 通常動作
          L2 = 7'b0000010,  // 年設定
          L7 = 7'b1000000;  // 秒設定

// 各カウンタは必要なビットだけ受け取る
input [1:0] SET_CURRENT_STATE;
// [0]: 通常動作中
// [1]: この桁を設定中
```

### 3. アラームモード（実装予定）

指定時刻にアラーム音を鳴らす機能。

### 4. ストップウォッチモード（実装予定）

0.01秒単位の計測、スタート/ストップ/リセット機能。

### 5. タイマーモード（実装予定）

カウントダウンタイマー、時間設定・開始・停止機能。

---

## 主な技術

### 1. 状態遷移設計

**MAIN_MODE（動作モード）**:
```verilog
parameter L1 = 5'b00001,  // 時刻表示モード
          L2 = 5'b00010,  // 時刻設定モード
          L3 = 5'b00100,  // アラームモード（実装予定）
          L4 = 5'b01000,  // ストップウォッチモード（実装予定）
          L5 = 5'b10000;  // タイマーモード（実装予定）
```

### 2. レジスタの統一

**従来の設計（非効率）**:
```verilog
// 表示用と設定用でレジスタが別々
reg [3:0] DISP_YEAR, SET_YEAR;  // 2倍のリソース

// 設定完了時にコピー処理が必要
DISP_YEAR <= SET_YEAR;
```

**統一設計（効率的）**:
```verilog
// 共通レジスタを使用
reg [3:0] YEAR;

// 通常動作時: 自動カウント
// 設定モード時: INC_MODEで変更
// コピー処理不要、シームレスな動作
```

**効果**: レジスタ数50%削減

### 3. MSEモジュールによる統合入力処理

**3つの機能を1モジュールに統合**:

```verilog
module MSE(CLK, MODE_IN, MODE, ENABLE_kHz);
    reg [1:0] META;  // ① メタステビリティ対策（2段FF）
    reg [3:0] SFT;   // ② チャタリング除去（4ビットシフトレジスタ）
    reg [1:0] ED;    // ③ エッジ検出（立ち上がり検出）

    // ① 外部入力を2段FFで安定化
    always @(posedge CLK)
        META <= {META[0], MODE_IN};

    // ② 4回連続で同じ値の時だけ有効
    always @(posedge CLK)
        if(ENABLE_kHz == 1'b1)
            SFT <= {SFT[2:0], META[1]};
    wire CHATA = & SFT;

    // ③ 立ち上がりエッジでパルス出力
    always @(posedge CLK)
        ED <= {ED[0], CHATA};
    assign MODE = ED[0] & ~ED[1];
endmodule
```

### 4. 曜日表示の実装

**DECODER7.vの拡張**:
```verilog
// 曜日表示モード判定
if(TOP_CURRENT_STATE == 1'b1 && DIS_CURRENT_STATE[0] == 1'b1) begin
    case(SA[1:0])
        2'b01:  // 1桁目 (U, O, U, E, H, R, A)
            case(COUNT)
                4'b0000: LED <= 8'b0011100_0; // U (日曜日)
                4'b0001: LED <= 8'b0011101_0; // O (月曜日)
                // ...
            endcase
        2'b10:  // 2桁目 (S, M, T, W, T, F, S)
            case(COUNT)
                4'b0000: LED <= 8'b0011011_0; // S (日曜日)
                4'b0001: LED <= 8'b1110110_0; // M (月曜日)
                // ...
            endcase
    endcase
end
```

**設計思想**:
- 7セグメントLEDで表現可能な2文字のアルファベット
- 全7曜日でユニークなパターン
- 可読性を重視したデザイン

---

## 実機テスト結果

### 短期動作テスト（24時間）

```
開始: 2024/11/15 00:00:00 (金曜)
終了: 2024/11/16 00:00:00 (土曜)

確認した時刻数: 48回
エラー発生回数: 0回
成功率: 100% ✅
```

### 長期動作テスト（72時間）

```
開始: 2024/11/18 00:00:00 (月曜)
終了: 2024/11/21 00:00:00 (木曜)

稼働時間: 72時間（3日間）
エラー発生回数: 0回
成功率: 100% ✅

特記事項:
- 時刻の累積誤差: 検出限界以下（<0.1秒）
- FPGAチップ温度: 約45℃（安定）
- 表示品質: 劣化なし
```

### 機能別動作確認

| 機能 | 確認項目 | 結果 |
|------|---------|------|
| 時刻表示 | 年月日曜日・時分秒の表示 | ✅ 正常 |
| 時刻表示 | 7種類の表示切替 | ✅ 正常 |
| 時刻設定 | 各桁の個別設定 | ✅ 正常 |
| 時刻設定 | 点滅表示 | ✅ 正常 |
| 入力処理 | ボタン応答性 | ✅ 良好 |
| 入力処理 | チャタリング除去 | ✅ 正常 |

---

## リソース使用状況

```
==================================================
リソース使用状況
==================================================

Slice LUTs:         390 / 53,200  (0.73%) ✅
Slice Registers:    154 / 106,400 (0.14%) ✅
Block RAM:          0.5 / 50      (1.00%) ✅
最大動作周波数:     125 MHz以上達成 ✅
```

### 最適化効果

| 項目 | 最適化前 | 最適化後 | 削減率 |
|------|---------|---------|--------|
| Slice LUTs | ~520 | 390 | 25% |
| デコーダ数 | 4個 | 1個 | 75% |
| レジスタ数 | ~200 | 154 | 23% |

---

## 学習ポイント

### 1. 大規模システムの統合

- Phase 2とPhase 3の成果を統合
- モジュール間のインターフェース設計
- 階層的な構造による保守性向上

### 2. ワンホットエンコーディング

- 状態判定の高速化
- デコード回路不要
- 配線リソース削減

### 3. 実機テスト

- 72時間連続動作での安定性確認
- 温度特性の確認
- 実用レベルの品質保証

---

## 今後の実装予定

### アラーム機能
- [ ] 指定時刻の設定
- [ ] アラーム音の出力（圧電ブザー）
- [ ] 複数アラームの管理

### ストップウォッチ機能
- [ ] 0.01秒単位の計測
- [ ] スタート/ストップ/リセット
- [ ] ラップタイム記録

### タイマー機能
- [ ] カウントダウンタイマー
- [ ] 時間設定機能
- [ ] タイムアップ通知

---

## まとめ

Phase 4では、すべての技術を統合し、実用レベルのデジタル時計を実現しました。

**達成した目標**:
- ✅ 101年間の正確な動作（2000-2100年）
- ✅ 123,290パターンの全網羅テスト成功
- ✅ 72時間連続動作の安定性確認
- ✅ リソース使用率1%未満

**習得した技術**:
- ✅ 大規模システムの設計・統合
- ✅ 状態遷移設計（FSM）
- ✅ 徹底した検証プロセス
- ✅ 実機での動作確認

この成果は、組込みエンジニアとしての基礎力を示すものであり、就職活動において技術力の証明となります。
