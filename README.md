# 101年対応FPGAデジタル時計プロジェクト

![Zybo Z7-20](https://img.shields.io/badge/FPGA-Zybo%20Z7--20-blue)
![Verilog](https://img.shields.io/badge/Language-Verilog%20HDL-green)
![C](https://img.shields.io/badge/Verification-C%20Language-orange)
![Status](https://img.shields.io/badge/Status-Completed-success)

**2000年～2100年まで完全対応するデジタル時計をFPGAで完全自力実装**

東京都立中央・城北職業能力開発センター板橋校 IoTシステム科  
開発期間：2024年9月～11月（約2ヶ月）

---

## 📌 プロジェクト概要

このプロジェクトは、FPGA（Zybo Z7-20）と4桁7セグメントLEDを使用して、**101年間正確に動作するデジタル時計**を完全に自力で実装したものです。

### 🎯 主な特徴

- **101年間の完全動作**: 2000/01/01 00:00:00 (土) ～ 2100/12/31 23:59:59 (木)
- **完全自力実装**: 既存コードに依存せず、すべて独自設計
- **徹底した品質保証**: 123,290パターンの全網羅テスト成功
- **高度な技術実装**: 8つの技術的工夫による最適化

### 📊 開発規模

| 項目 | 詳細 |
|------|------|
| コード規模 | 16モジュール、約850行（Verilog HDL） |
| 検証パターン数 | 123,290パターン（86,400 + 36,890） |
| リソース使用率 | LUT: 0.73%, FF: 0.14%, BRAM: 1.00% |
| 動作周波数 | 125 MHz |

---

## 🚀 実装機能

### ✅ 完成済み機能

1. **時刻表示モード**
   - 年月日・曜日・時分秒のリアルタイム表示
   - うるう年自動判定
   - 101年間のループ動作

2. **時刻設定モード**
   - 年・月・日・時・分・秒を個別設定
   - 設定中の桁を点滅表示
   - ボタンでインクリメント操作

3. **曜日表示**
   - オリジナル7セグメントパターン（SU, MO, TU, WE, TH, FR, SA）
   - ブロックRAMによる高速計算

### 🔄 実装予定機能

- アラーム機能
- ストップウォッチ機能
- タイマー機能

---

## 💻 技術スタック

### ハードウェア

- **FPGA**: Xilinx Zybo Z7-20 (Zynq-7000)
- **ディスプレイ**: 4桁7セグメントLED
- **入力**: 4個のプッシュボタン

### ソフトウェア

- **開発環境**: Vivado 2023.2
- **HDL**: Verilog HDL
- **検証**: C言語（gcc）
- **シミュレータ**: Vivado Simulator

---

## 🏗️ システムアーキテクチャ

### 階層構造

```
CLOCK_ALL (トップモジュール)
├─ SEC1 (1秒クロック生成)
├─ MAIN_MODE (動作モード管理)
├─ SET_MODE (設定モード処理)
├─ DIS_MODE (表示切替処理)
├─ カウンタ群
│  ├─ CNT_YEAR (年カウンタ、2000-2100年)
│  ├─ CNT_MONTH (月カウンタ、1-12月)
│  ├─ CNT_DAY (日カウンタ、月ごとの日数対応)
│  ├─ weekday_calc (曜日計算、ブロックRAM使用)
│  ├─ leap_year (うるう年判定)
│  ├─ CNT24 (時カウンタ、0-23時)
│  └─ CNT60 x2 (分・秒カウンタ、0-59)
├─ 表示制御群
│  ├─ display_switch (表示データ切替)
│  ├─ DECODER7 (7セグメントデコーダ)
│  └─ DCOUNT (ダイナミック点灯制御)
└─ 入力処理
   └─ MSE x4 (メタステビリティ + チャタリング + エッジ検出)
```

### データフロー

```
125MHz CLK → SEC1 → ENABLE (1Hz)
                      ↓
CNT60(秒) →carry→ CNT60(分) →carry→ CNT24(時) →carry→ 
CNT_DAY(日) →carry→ CNT_MONTH(月) →carry→ CNT_YEAR(年)
                      ↓
            weekday_calc (曜日)
                      ↓
            display_switch → DECODER7 → LED
                      ↓
            DCOUNT (ダイナミック点灯)
```

---

## 🔧 技術的工夫（8つのポイント）

### 1. 条件信号による同期カウンタ設計
- 全カウンタが同一CLK（125MHz）で動作
- carry信号連鎖による論理的依存関係
- 時間的な遅延ゼロ、デバッグが容易

### 2. ブロックRAMによる曜日計算最適化
- Zellerの公式の複雑な演算を回避
- 1,212エントリのルックアップテーブル
- Critical Path短縮、高速動作実現

### 3. ダイナミック点灯制御の最適化
- デコーダ数: 4個 → 1個（75%削減）
- データ幅: 32bit → 16bit
- リソース使用量を大幅削減

### 4. MSEモジュールの統合設計
- メタステビリティ対策
- チャタリング対策
- エッジ検出
- 3機能を1モジュールに統合

### 5. レジスタの統一
- 表示用と設定用を統合（レジスタ数50%削減）
- コピー処理不要でシームレスな動作

### 6. 境界値テストによる厳密な検証
- うるう年境界（2000/02/28-29、2001/02/28-03/01）
- 年またぎ（2000/12/31-2001/01/01）
- 世紀またぎ（2099/12/31-2100/01/01）
- ロールオーバー（2100/12/31-2000/01/01）

### 7. TCL Consoleでの7セグLED可視化
- シミュレーション中にLED形状を表示
- 実機テスト前の動作確認
- デバッグ時間の大幅短縮

### 8. ワンホットエンコーディングの採用
- 状態判定の高速化
- デコード回路不要
- 配線リソース削減

---

## ✅ 検証プロセス

### 全網羅テスト

**Phase 1: 24時間プロジェクト**
- テストパターン: 86,400件（00:00:00 ～ 23:59:59）
- C言語でリファレンス生成（CountReference.c）
- Verilogテストベンチで全パターン検証
- 結果: ✅ 全パターン一致

**Phase 2: 年月日曜日プロジェクト**
- テストパターン: 36,890件（2000/01/01 ～ 2100/12/31）
- C言語でリファレンス生成（DMY_ref.c）
- うるう年・月末日数・曜日を完全検証
- 結果: ✅ 全パターン一致

**Phase 3: 統合プロジェクト**
- Phase 1とPhase 2の成果を統合
- 境界値テスト6パターン実施
- 5機能の動作確認
- 結果: ✅ すべて正常動作

### 検証手法の特徴

1. **C言語による大規模データ生成**
   - 人間が確認不可能な規模を自動化
   - BCD形式のカウント値を全パターン列挙

2. **厳密なタイミング制御**
   - `@(negedge ENABLE)` → リファレンス読込
   - `@(posedge ENABLE)` → 回路動作
   - `@(negedge clk)` → データ確定待機
   - 検証

3. **=== 演算子による厳密比較**
   - 不定値（X）も含めて検証
   - 初期化忘れを確実に検出

---

## 📈 シンセシス結果

**ターゲットデバイス**: Artix-7 (XC7A35TICSG324-1L)

| リソース種類 | 使用量 | 利用可能 | 使用率 |
|-------------|--------|----------|--------|
| Slice LUTs | 390 | 53,200 | 0.73% |
| Slice Registers (FF) | 154 | 106,400 | 0.14% |
| F7 Muxes | 10 | 26,600 | 0.04% |
| Block RAM (BRAM) | 0.5 | 50 | 1.00% |
| DSP | 0 | 90 | 0.00% |
| Bonded IOB | 17 | 210 | 8.10% |

**最大動作周波数**: 125 MHz以上達成

---

## 🎮 追加プロジェクト: 的当てゲーム

技能祭（2024年10月）で展示した作品

### システム構成
- **FPGA**: Basys3 (Artix-7)
- **LED**: 32×32 RGBマトリクス 9枚（合計288×288ピクセル）
- **画像処理**: Raspberry Pi 4 + Camera + OpenCV

### 技術的特徴
- 独自の当たり判定アルゴリズム（X座標転換点検出）
- 6状態の状態遷移マシン
- 27種類のゲーム画面パターン
- FPGA + ラズパイのハイブリッド構成

---

## 📚 ドキュメント

- [詳細技術資料](./TECHNICAL.md) - アーキテクチャ、実装の詳細
- [開発プロセス](./DEVELOPMENT.md) - 段階的開発手法、検証フロー
- [モジュール仕様](./MODULES.md) - 各モジュールの詳細仕様
- [検証レポート](./VERIFICATION.md) - テスト結果、境界値テスト

---

## 🗂️ ディレクトリ構造

```
.
├── P1_*.v                    # Phase 1: 基本カウンタ
├── P2_*.v                    # Phase 2: 24時間カウンタ
├── P3_*.v                    # Phase 3: 年月日曜日カウンタ
├── P4_*.v                    # Phase 4: 統合プロジェクト
├── P*_*.c                    # C言語検証コード
├── presentation_12_17_final.pdf  # 技術プレゼンテーション
├── README.md                 # このファイル
├── TECHNICAL.md              # 詳細技術資料
├── DEVELOPMENT.md            # 開発プロセス
├── MODULES.md                # モジュール仕様
└── VERIFICATION.md           # 検証レポート
```

---

## 🎓 習得した技術スキル

### ハードウェア設計
- Verilog HDL
- 階層設計・モジュール分割
- 状態遷移設計（FSM）
- タイミング制約
- ブロックRAM活用
- Critical Path最適化
- リソース削減技法

### 検証・デバッグ
- テストベンチ設計
- シミュレーション
- 全網羅テスト手法
- 境界値テスト
- タイミング解析
- 論理合成結果の読解

### ソフトウェア連携
- C言語プログラミング
- リファレンスデータ生成
- ファイルI/O
- データフォーマット変換

### 開発プロセス
- 段階的開発手法
- 要件定義
- 設計・実装・検証サイクル
- ドキュメント作成

---

## 🎯 今後の展望

### 短期目標（3ヶ月以内）
- [ ] アラーム機能の実装
- [ ] ストップウォッチ機能の実装
- [ ] タイマー機能の実装
- [ ] 音声出力機能（圧電ブザー）

### 中期目標（半年～1年）
- [ ] GPS/電波時計モジュール連携
- [ ] 温度・湿度センサー追加
- [ ] PCB設計・製作
- [ ] ラズパイ + FPGA連携による高度なIoT機器開発

### キャリア目標
組込みエンジニアとして、ハードウェアとソフトウェアの両面から製品開発に貢献

---

## 📞 連絡先

**笠井 春希**  
東京都立中央・城北職業能力開発センター板橋校  
IoTシステム科

---

## 📄 ライセンス

このプロジェクトは学習・研究目的で作成されました。

---

## 🙏 謝辞

このプロジェクトは、東京都立中央・城北職業能力開発センター板橋校 IoTシステム科での学習の集大成として作成しました。指導していただいた先生方、サポートしてくれた同級生の皆様に感謝いたします。
